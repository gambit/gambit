#! /bin/sh

# Script parameters are passed in the following environment variables:
    GAMBDOC_GAMBITDIR_BIN=$(dirname ${0})
#   GAMBDOC_GAMBITDIR_DOC
#   GAMBDOC_BROWSER
    GAMBDOC_ARG1=${1:-help}
    GAMBDOC_ARG2=$2
#   ...

# echo GAMBDOC_GAMBITDIR_BIN = "${GAMBDOC_GAMBITDIR_BIN}"
# echo GAMBDOC_GAMBITDIR_DOC = "${GAMBDOC_GAMBITDIR_DOC}"
# echo GAMBDOC_BROWSER = "${GAMBDOC_BROWSER}"
# echo GAMBDOC_ARG1 = "${GAMBDOC_ARG1}"
# echo GAMBDOC_ARG2 = "${GAMBDOC_ARG2}"

find_in_path() # exe-name, sets `$exe'
{
	exe=$(which "${1}");
	# Alternatively, use $(command) somehow
	if [ -f "$exe" ]; then
		return 0
	else
		return 1
	fi
}

find_browser() # sets `$exe'
{
	browser_list=("${GAMBDOC_BROWSER}")
  if [ "@HELP_BROWSER@" != "" ]; then
		browser_list+=("@HELP_BROWSER@")
  else
    browser_list+=("lynx" "firefox" "mozilla" "netscape" "osascript" "chrome" "chromium" "chromium-browser")
  fi

  for b in "${browser_list[@]}"; do
		if exe=$(find_in_path "${b}"); then
			echo "${exe}"
      return 0
    fi
  done
	echo "${browser_list[@]}"
  return 1
}

operation_help() # sets `$exe'
{
	if browser=$(find_browser); then
    url="file://${GAMBDOC_GAMBITDIR_DOC}/gambit.html#${GAMBDOC_ARG2}"
		case "$(basename ${browser})" in
      osascript ) "${browser}" <<EOF ;;
tell application "Safari"
    open location "$url"
end tell
EOF
              * ) $exe $url ;;
    esac
  else
    echo "*** WARNING -- none of these browsers can be found to view the documentation:"
    echo "***            ${browser}"
    exit 1
  fi
}

if [ "${GAMBDOC_ARG1}" = "help" ]; then
  operation_help
else
  echo "*** WARNING -- unsupported operation: ${GAMBDOC_ARG1}"
  exit 1
fi
